# 第2章 資料處理

## 2.3 特徵工程

### 特徵工程目標

為了深入分析「守法vs.效益」的道德兩難，本研究建立以下特徵：

1. **場景層級特徵**：標記每個選擇的守法性、多數性、衝突性
2. **國家層級特徵**：整合國家的道德偏好 AMCE 值（用於階層模型）
3. **使用者道德側寫**：量化每位使用者的道德傾向（僅用於探索）

### 場景層級特徵

| 特徵名稱 | 說明 | 平均值 |
|---------|------|--------|
| is_lawful | 該側是否守法（1=守法綠燈, 0=違法紅燈） | 0.500 |
| is_majority | 該側是否為多數（1=人數較多, 0=人數較少） | 0.500 |
| chose_lawful | 使用者是否選擇守法側（1=是, 0=否） | 0.349 |
| chose_majority | 使用者是否選擇多數側（1=是, 0=否） | 0.373 |
| lawful_vs_majority_conflict | 守法和多數是否衝突（1=衝突, 0=一致） | 0.496 |

#### 關鍵發現

- **守法選擇率**: 69.7%
- **多數選擇率**: 74.5%
- **衝突場景比例**: 49.6%

### 國家層級特徵

從 `CountriesChangePr.csv` 整合國家的道德偏好 AMCE 值，用於階層線性模型分析。

**已整合的國家特徵**:

- `country_law_preference`: 國家層級守法偏好（AMCE）
  - 平均值: 0.357, 標準差: 0.029
- `country_utilitarian`: 國家層級效益主義傾向（AMCE）
  - 平均值: 0.503, 標準差: 0.042
- `country_intervention`: 國家層級介入偏好（AMCE）
  - 平均值: 0.059, 標準差: 0.017
- `country_pedestrian_pref`: 國家層級行人優先偏好（AMCE）
  - 平均值: 0.092, 標準差: 0.057
- `country_gender_pref`: 國家層級性別偏好（AMCE）
  - 平均值: 0.119, 標準差: 0.040
- `country_fitness_pref`: 國家層級體型偏好（AMCE）
  - 平均值: 0.156, 標準差: 0.030
- `country_status_pref`: 國家層級社會地位偏好（AMCE）
  - 平均值: 0.345, 標準差: 0.030
- `country_age_pref`: 國家層級年齡偏好（AMCE）
  - 平均值: 0.490, 標準差: 0.045
- `country_species_pref`: 國家層級物種偏好（AMCE）
  - 平均值: 0.577, 標準差: 0.098

### 國家特徵缺失處理策略

**缺失情況**：
- 共 476 行（0.13%）無法對應國家層級 AMCE 特徵
- 這些資料來自未被納入原始研究 130 國統計的小國
- 對應於 Cluster == -1 (Unclassified)

**處理策略**：
根據不同分析目的採取不同策略：

| 章節 | 處理方式 | 理由 |
|------|---------|------|
| 第3章 | 排除無國家特徵資料 | 跨文化比較需要完整的國家統計 |
| 第4章 | 排除無國家特徵資料 | 階層線性模型需要完整的群組變數 |
| 第5章 | 保留所有資料 | XGBoost 可處理缺失值並學習小國模式 |

為便於後續分析，已在資料中新增 `has_country_features` 標記欄位，
用於快速篩選具有完整國家特徵的資料。

**理論依據**：
- 缺失機制為 MNAR（缺失非隨機）：小國未被納入統計本身就是一種特徵
- 預測模型可將「來自小國」視為一種可學習的模式
- 佔比極低（0.13%），對第3、4章分析影響微乎其微

### 使用者道德側寫

基於使用者在衝突場景中的選擇，建立道德傾向側寫。

**⚠️ 重要：為避免資料洩漏，使用者側寫分別基於訓練集和測試集計算**

- 訓練集使用者側寫：僅使用訓練集資料計算
- 測試集使用者側寫：僅使用測試集資料計算
- 使用者側寫**不應用於預測模型**，僅用於探索性分析

| 側寫指標 | 說明 | 平均值 | 標準差 |
|---------|------|--------|--------|
| utilitarian_score | 效益主義分數：選擇多數的比例 [0, 1] | 0.549 | 0.492 |
| deontology_score | 義務論分數：選擇守法的比例 [0, 1] | 0.451 | 0.492 |
| consistency_score | 決策一致性：決策模式的穩定度 [0, 1] | 0.989 | 0.073 |
| n_scenarios | 使用者完成的衝突場景數量 | 1.084 | 0.290 |

- **側寫使用者數**: 86,401 位
- **平均完成場景數**: 1.1 個

### 道德傾向分佈

**效益主義傾向分佈**:

- 強效益主義 (>0.7): 46,471 位 (53.8%)
- 中間派 (0.3-0.7): 1,898 位 (2.2%)
- 強義務論 (<0.3): 38,032 位 (44.0%)

### 訓練/測試集分割

採用使用者層級分割（80/20），確保同一使用者的資料不會同時出現在訓練集和測試集，避免資料洩漏。

- **訓練集**: 約 302,074 行
- **測試集**: 約 75,518 行

### 特徵使用注意事項

不同分析階段適用的特徵：

**第3章 探索性分析**:
- ✅ 場景層級特徵
- ✅ 國家層級特徵
- ✅ 使用者道德側寫（用於分群和描述）

**第4章 統計推論**:
- ✅ 場景層級特徵
- ✅ 國家層級特徵（用於階層線性模型）
- ❌ 使用者道德側寫（避免循環論證）

**第5章 預測模型**:
- ✅ 場景層級特徵
- ✅ 人口統計變數
- ✅ 文化圈分類
- ❌ 使用者道德側寫（會造成資料洩漏）

特徵工程完成後，資料已準備好進行探索性分析和建模。

